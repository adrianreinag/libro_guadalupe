---
import BaseLayout from "../layouts/BaseLayout.astro";
import Stories from "../components/instagram/Stories";
import Post from "../components/instagram/Post";
import ButtonNavigationBar from "../components/instagram/ButtonNavigationBar";
import HeaderNotifications from "../components/instagram/HeaderNotifications";
import { storiesConfig } from "../data/instagram/storiesConfig";

// Pasar TODA la configuración al cliente (sin filtrar)
// El filtrado se hará en el componente Stories en el lado del cliente
const storiesData = storiesConfig.map(user => ({
  userId: user.userId,
  imagenPerfil: user.imagenPerfil,
  nombreUsuario: user.nombreUsuario,
  mejorAmigo: user.mejorAmigo || false,
  historia: user.historias.map(h => ({
    id: h.id,
    tipo: h.tipo,
    url: h.url,
    duration: h.duration,
    // Serializar las fechas como strings ISO para pasarlas al cliente
    startDate: h.startDate.toISOString(),
    endDate: h.endDate.toISOString(),
  })),
  visto: false, // Se calculará dinámicamente en el componente
}));

// Datos de ejemplo para los posts
const postsData = [
  {
    imagenPost: "/assets/instagram/posts/oracion.jpg",
    imagenUsuario: "/assets/instagram/profiles/La_Dele_Avatar.png",
    nombreUsuario: "delejuventud",
    descripcion: "Pulsa en la imagen para entrar en la sección de oración.",
    likes: 3453,
    urlRedireccion: "/devocionario",
  },
  {
    imagenPost: "/assets/instagram/posts/devocionario.jpg",
    imagenUsuario: "/assets/instagram/profiles/La_Dele_Avatar.png",
    nombreUsuario: "delejuventud",
    descripcion: "Pulsa en la imagen para entrar en la sección de ubicaciones.",
    likes: 5543,
    urlRedireccion: "/ubicaciones",
  },
];
---

<BaseLayout title="Instagram">
  <div class="bg-gray-50 min-h-screen">
    <div class="max-w-2xl mx-auto bg-white min-h-screen">
      <!-- Header -->
      <header class="bg-white p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-1">
            <h1 class="text-2xl font-semibold">Para ti</h1>
            <button id="arrowButton" class="cursor-pointer">
              <img src="/assets/instagram/icons/arrow_down.svg" alt="Arrow down" class="w-5 h-5" />
            </button>
          </div>
          <div class="flex gap-4 items-center">
            <HeaderNotifications client:load />
            <button
              id="shareButton"
              class="hover:opacity-70 transition-opacity active:scale-95 transition-transform p-2 -m-2 relative z-10"
              type="button"
            >
              <img src="/assets/instagram/icons/direct.svg" alt="Compartir" class="w-7 h-7 pointer-events-none" />
            </button>
          </div>
        </div>
      </header>

      <!-- Stories -->
      <Stories client:load miImagen="/assets/instagram/profiles/Me_Avatar.jpg" stories={storiesData} />

      <!-- Posts -->
      <div class="pb-16">
        {postsData.map((post) => (
          <Post
            client:load
            imagenPost={post.imagenPost}
            imagenUsuario={post.imagenUsuario}
            nombreUsuario={post.nombreUsuario}
            descripcion={post.descripcion}
            likes={post.likes}
            urlRedireccion={post.urlRedireccion}
            instagramUrl="https://www.instagram.com/delejuventud/"
          />
        ))}
      </div>
    </div>

    <!-- Navigation Bar -->
    <ButtonNavigationBar
      client:load
      reelsUrl="https://youtu.be/M_EZxQUGDn4?si=Eh1jRvYU5Zg9_CXY"
      postUrl="https://www.instagram.com/delejuventud/"
    />
  </div>
</BaseLayout>

<style>
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px) rotate(-5deg); }
    20%, 40%, 60%, 80% { transform: translateX(3px) rotate(5deg); }
  }

  .shake-animation {
    animation: shake 0.5s ease-in-out;
  }
</style>

<script>
  // Funcionalidad de vibración para el icono de flecha
  const arrowButton = document.getElementById('arrowButton');

  if (arrowButton) {
    arrowButton.addEventListener('click', () => {
      // Agregar la clase de animación
      arrowButton.classList.add('shake-animation');

      // Remover la clase después de que termine la animación
      setTimeout(() => {
        arrowButton.classList.remove('shake-animation');
      }, 500); // 500ms coincide con la duración de la animación
    });
  }

  // Funcionalidad de compartir para el botón Direct del header
  const shareButton = document.getElementById('shareButton');

  if (shareButton) {
    shareButton.addEventListener('click', async () => {
      const url = window.location.href;
      const title = 'Libro Guadalupe';
      const text = '¡Mira este contenido en Libro Guadalupe!';

      // Verificar si el navegador soporta Web Share API
      if (navigator.share) {
        try {
          await navigator.share({
            title: title,
            text: text,
            url: url,
          });
        } catch (error) {
          // Si el usuario cancela, no hacer nada
          if ((error as Error).name !== 'AbortError') {
            console.error('Error al compartir:', error);
            fallbackShare(url);
          }
        }
      } else {
        fallbackShare(url);
      }
    });
  }

  function fallbackShare(url: string) {
    // Copiar al portapapeles como fallback
    navigator.clipboard.writeText(url).then(() => {
      alert('¡Enlace copiado al portapapeles!');
    }).catch(() => {
      // Si falla copiar al portapapeles, mostrar el enlace
      prompt('Copia este enlace:', url);
    });
  }
</script>
